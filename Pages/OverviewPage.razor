@page "/"
@page "/overview"
@using BlazorClient.Models
@using BlazorClient.Services
@using Blazored.LocalStorage
@inject WeatherApiService Api
@inject WeatherHubService Hub
@inject ILocalStorageService LocalStorage
@implements IAsyncDisposable

<PageTitle>CAVOK - Oversigt</PageTitle>

<div class="header">
    <div class="header-left">
        <h1>üõ´ CAVOK</h1>
        <span class="subtitle">METAR/TAF Monitor</span>
    </div>
    <div class="header-right">
        <span class="connection-status @(isConnected ? "connected" : "disconnected")">
            @(isConnected ? "‚óè Live" : "‚óã Offline")
        </span>
        <span class="current-time">@currentTime.ToString("HH:mm:ss")z</span>
    </div>
</div>

<div class="controls">
    <div class="add-airport">
        <input type="text"
               @bind="newIcao"
               @bind:event="oninput"
               @onkeydown="OnKeyDown"
               placeholder="ICAO (fx EKCH)"
               maxlength="4"
               class="icao-input" />
        <button @onclick="AddAirport" disabled="@(newIcao.Length != 4)" class="btn btn-primary">
            Tilf√∏j
        </button>
    </div>

    <div class="actions">
        <button @onclick="AcknowledgeAll" class="btn btn-secondary">
            ‚úì Kvitter alle
        </button>
        <button @onclick="ClearAll" class="btn btn-danger">
            üóë Ryd alle
        </button>
        <button @onclick="ForceRefresh" class="btn btn-secondary">
            ‚Üª Opdater
        </button>
    </div>

    <div class="filters">
        <label>
            <input type="checkbox" @bind="showNewMetar" /> Vis nye METAR
        </label>
        <label>
            <input type="checkbox" @bind="showNewTaf" /> Vis nye TAF
        </label>
    </div>
</div>

@if (errorMessage != null)
{
    <div class="error-message">
        @errorMessage
        <button @onclick="() => errorMessage = null">√ó</button>
    </div>
}

@if (isLoading)
{
    <div class="loading">Indl√¶ser...</div>
}
else if (airports.Count == 0)
{
    <div class="empty-state">
        <div class="empty-icon">‚úàÔ∏è</div>
        <h2>Ingen lufthavne</h2>
        <p>Tilf√∏j en lufthavn ovenfor for at se METAR og TAF data.</p>
        <p class="hint">Pr√∏v fx: EKCH, EKBI, EGLL, KJFK</p>
    </div>
}
else
{
    <div class="airport-list">
        @foreach (var airport in airports)
        {
            var metarIsNew = airport.LatestMetar != null &&
            ackTracker.IsMetarNew(airport.Icao, airport.LatestMetar.ReportTimeUtc);
            var tafIsNew = airport.LatestTaf != null &&
            ackTracker.IsTafNew(airport.Icao, airport.LatestTaf.ReportTimeUtc);
            var isAmd = airport.LatestTaf?.IsAmendment ?? false;

            <div class="airport-card @(tafIsNew && isAmd && showNewTaf ? "amd-alert" : "")">
                <div class="airport-header">
                    <div class="airport-info">
                        <span class="icao">@airport.Icao</span>
                        @if (!string.IsNullOrEmpty(airport.Country))
                        {
                            <span class="country">@airport.Country</span>
                        }
                    </div>
                    <div class="airport-actions">
                        <button @onclick="() => AcknowledgeAirport(airport)" title="Kvitter" class="btn-icon">‚úì</button>
                        <button @onclick="() => RemoveAirport(airport.Icao)" title="Fjern" class="btn-icon btn-remove">√ó</button>
                    </div>
                </div>

                @* TAF *@
                <div class="report-line @(tafIsNew && showNewTaf ? (isAmd ? "new-amd" : "new-report") : "")">
                    <span class="report-type taf">TAF</span>
                    <span class="badge-area">
                        @if (airport.LatestTaf != null)
                        {
                            @if (isAmd)
                            {
                                <span class="badge amd">AMD</span>
                            }
                            @if (airport.LatestTaf.Type.Contains("COR"))
                            {
                                <span class="badge cor">COR</span>
                            }
                        }
                    </span>
                    <span class="report-raw">@(airport.LatestTaf?.Raw ?? "Ingen TAF tilg√¶ngelig")</span>
                    @if (airport.LatestTaf != null)
                    {
                        <span class="report-time">
                            @airport.LatestTaf.ReportTimeUtc.ToString("HH:mm")z
                            <span class="age">(@FormatAge(airport.LatestTaf.ReportTimeUtc))</span>
                        </span>
                    }
                </div>

                @* METAR *@
                <div class="report-line @(metarIsNew && showNewMetar ? "new-report" : "")">
                    <span class="report-type metar">METAR</span>
                    <span class="badge-area">
                        @if (airport.LatestMetar != null)
                        {
                            @if (airport.LatestMetar.Type.Contains("SPECI"))
                            {
                                <span class="badge speci">SPECI</span>
                            }
                            @if (airport.LatestMetar.Type.Contains("COR"))
                            {
                                <span class="badge cor">COR</span>
                            }
                        }
                    </span>
                    <span class="report-raw">@(airport.LatestMetar?.Raw ?? "Ingen METAR tilg√¶ngelig")</span>
                    @if (airport.LatestMetar != null)
                    {
                        <span class="report-time">
                            @airport.LatestMetar.ReportTimeUtc.ToString("HH:mm")z
                            <span class="age">(@FormatAge(airport.LatestMetar.ReportTimeUtc))</span>
                        </span>
                    }
                </div>
            </div>
        }
    </div>
}

<div class="footer">
    Data fra NorthAviMet ‚Ä¢ Opdateres automatisk via SignalR
</div>

@code {
    private List<AirportDto> airports = new();
    private AckTracker ackTracker = new();
    private string newIcao = string.Empty;
    private string? errorMessage;
    private bool isLoading = true;
    private bool isConnected;
    private bool showNewMetar = true;
    private bool showNewTaf = true;
    private DateTime currentTime = DateTime.UtcNow;
    private Timer? timer;

    private const string AirportsKey = "cavok_airports";
    private const string AckMetarKey = "cavok_ack_metar";
    private const string AckTafKey = "cavok_ack_taf";

    protected override async Task OnInitializedAsync()
    {
        // Start ur
        timer = new Timer(_ =>
        {
            currentTime = DateTime.UtcNow;
            InvokeAsync(StateHasChanged);
        }, null, 0, 1000);

        // Setup SignalR events
        Hub.OnWeatherUpdate += OnWeatherUpdate;
        Hub.OnConnected += () => { isConnected = true; InvokeAsync(StateHasChanged); };
        Hub.OnDisconnected += () => { isConnected = false; InvokeAsync(StateHasChanged); };

        try
        {
            // Load fra localStorage
            await LoadAirportsAsync();
            await LoadAcksAsync();

            // Connect SignalR
            await Hub.ConnectAsync();
            isConnected = Hub.IsConnected;

            // Subscribe til alle lufthavne
            foreach (var ap in airports)
            {
                await Hub.SubscribeToAirportAsync(ap.Icao);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fejl ved opstart: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnWeatherUpdate(WeatherUpdateDto update)
    {
        var airport = airports.FirstOrDefault(a => a.Icao.Equals(update.Icao, StringComparison.OrdinalIgnoreCase));
        if (airport == null) return;

        if (update.NewMetar != null)
            airport.LatestMetar = update.NewMetar;
        if (update.NewTaf != null)
            airport.LatestTaf = update.NewTaf;

        InvokeAsync(StateHasChanged);
    }

    private async Task AddAirport()
    {
        var icao = newIcao.Trim().ToUpperInvariant();
        if (icao.Length != 4) return;

        if (airports.Any(a => a.Icao.Equals(icao, StringComparison.OrdinalIgnoreCase)))
        {
            errorMessage = $"{icao} er allerede tilf√∏jet";
            return;
        }

        try
        {
            errorMessage = null;
            var airport = await Api.SubscribeAsync(icao);

            if (airport == null)
            {
                errorMessage = $"Lufthavn {icao} blev ikke fundet";
                return;
            }

            airports.Add(airport);
            await Hub.SubscribeToAirportAsync(icao);
            await SaveAirportsAsync();
            newIcao = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Fejl: {ex.Message}";
        }
    }

    private async Task RemoveAirport(string icao)
    {
        airports.RemoveAll(a => a.Icao.Equals(icao, StringComparison.OrdinalIgnoreCase));
        await Api.UnsubscribeAsync(icao);
        await Hub.UnsubscribeFromAirportAsync(icao);
        await SaveAirportsAsync();
    }

    private async Task ClearAll()
    {
        foreach (var ap in airports.ToList())
        {
            await Api.UnsubscribeAsync(ap.Icao);
            await Hub.UnsubscribeFromAirportAsync(ap.Icao);
        }
        airports.Clear();
        await SaveAirportsAsync();
    }

    private async Task AcknowledgeAirport(AirportDto airport)
    {
        if (airport.LatestMetar != null)
            ackTracker.AckMetar(airport.Icao, airport.LatestMetar.ReportTimeUtc);
        if (airport.LatestTaf != null)
            ackTracker.AckTaf(airport.Icao, airport.LatestTaf.ReportTimeUtc);
        await SaveAcksAsync();
    }

    private async Task AcknowledgeAll()
    {
        ackTracker.AckAll(airports);
        await SaveAcksAsync();
    }

    private async Task ForceRefresh()
    {
        try
        {
            await Api.ForceFetchAsync();

            // Refresh all airports
            var refreshed = await Api.GetAllAsync();
            foreach (var ap in refreshed)
            {
                var existing = airports.FirstOrDefault(a => a.Icao == ap.Icao);
                if (existing != null)
                {
                    existing.LatestMetar = ap.LatestMetar;
                    existing.LatestTaf = ap.LatestTaf;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Fejl ved opdatering: {ex.Message}";
        }
    }

    private async Task OnKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && newIcao.Length == 4)
        {
            await AddAirport();
        }
    }

    private async Task LoadAirportsAsync()
    {
        var icaos = await LocalStorage.GetItemAsync<List<string>>(AirportsKey) ?? new();

        foreach (var icao in icaos.Distinct(StringComparer.OrdinalIgnoreCase))
        {
            var airport = await Api.SubscribeAsync(icao);
            if (airport != null)
                airports.Add(airport);
        }
    }

    private async Task SaveAirportsAsync()
    {
        var icaos = airports.Select(a => a.Icao).ToList();
        await LocalStorage.SetItemAsync(AirportsKey, icaos);
    }

    private async Task LoadAcksAsync()
    {
        var metarAcks = await LocalStorage.GetItemAsync<Dictionary<string, DateTime>>(AckMetarKey);
        var tafAcks = await LocalStorage.GetItemAsync<Dictionary<string, DateTime>>(AckTafKey);
        ackTracker.Load(metarAcks, tafAcks);
    }

    private async Task SaveAcksAsync()
    {
        await LocalStorage.SetItemAsync(AckMetarKey, ackTracker.SnapshotMetar());
        await LocalStorage.SetItemAsync(AckTafKey, ackTracker.SnapshotTaf());
    }

    private string FormatAge(DateTime reportTime)
    {
        var age = currentTime - reportTime;
        if (age.TotalMinutes < 60)
            return $"{(int)age.TotalMinutes}m";
        return $"{(int)age.TotalHours}t {age.Minutes}m";
    }

    public async ValueTask DisposeAsync()
    {
        timer?.Dispose();
        Hub.OnWeatherUpdate -= OnWeatherUpdate;
        await Hub.DisposeAsync();
    }
}
